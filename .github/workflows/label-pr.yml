name: Label PR based on commit message

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  label_pr:
    runs-on: ubuntu-latest

    steps:
    - name: Check out the code
      uses: actions/checkout@v3

    - name: Get commit messages
      id: get_commit_messages
      run: |
        PR_NUMBER="${{ github.event.number }}"
        REPO="${{ github.repository }}"
        COMMIT_MESSAGES=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/vnd.github+json" https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/commits | jq -r '.[].commit.message')
        echo "commit_messages=$COMMIT_MESSAGES" >> $GITHUB_ENV

    - name: Determine label
      id: determine_label
      run: |
        label=""
        if echo "${{ env.commit_messages }}" | grep -iq "skill"; then
          label="skill"
        elif echo "${{ env.commit_messages }}" | grep -iq "knowledge"; then
          label="knowledge"
        fi
        echo "::set-output name=label::${label}"

    - name: Add label to PR
      if: steps.determine_label.outputs.label != ''
      run: |
        PR_NUMBER="${{ github.event.number }}"
        REPO="${{ github.repository }}"
        LABEL="${{ steps.determine_label.outputs.label }}"
        curl -L -X POST -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/vnd.github+json" https://api.github.com/repos/$REPO/issues/$PR_NUMBER/labels -d "{\"labels\":[\"$LABEL\"]}"
